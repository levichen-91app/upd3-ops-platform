openapi: 3.0.3
info:
  title: Notification Status Proxy API
  description: |
    推播狀態查詢統一代理服務

    ## 功能概述
    提供統一的推播狀態查詢介面，整合以下外部服務：
    - Marketing Cloud Device API (取得用戶裝置資訊)
    - Whale API (查詢通知歷程)
    - NC Detail API (取得通知詳細資訊)
    - NS Report API (查詢狀態報告)

    ## 錯誤處理
    所有API回應統一使用標準格式，包含：
    - 成功回應：`{ success: true, data: {...}, timestamp, requestId }`
    - 錯誤回應：`{ success: false, error: {...}, timestamp, requestId }`

  version: 1.0.0
  contact:
    name: UPD3 Ops Platform Team

servers:
  - url: /api/v1
    description: API v1

paths:
  /notification-status/devices:
    get:
      tags:
        - Notification Status
      summary: 查詢用戶裝置清單
      description: |
        透過商店ID和手機號碼查詢用戶的所有推播裝置

        **外部API**: Marketing Cloud Device API
        **路徑**: `/v1/shops/{shopId}/phones/{phone}/devices`
      operationId: getDevices
      parameters:
        - name: shopId
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
          description: 商店ID
          example: 12345
        - name: phone
          in: query
          required: true
          schema:
            type: string
            pattern: '^[0-9+\-\s()]+$'
            minLength: 8
            maxLength: 15
          description: 會員手機號碼
          example: "0912345678"
      responses:
        '200':
          description: 成功取得裝置清單
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DevicesResponse'
              example:
                success: true
                data:
                  - guid: "123e4567-e89b-12d3-a456-426614174000"
                    udid: "device_udid_123"
                    token: "device_token_123"
                    shopId: 12345
                    platformDef: "iOS"
                    memberId: 67890
                    advertiseId: "ad_id_123"
                    appVersion: "1.2.3"
                    createdDateTime: "2024-01-15T10:00:00Z"
                    updatedDateTime: "2024-01-15T10:30:00Z"
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-devices-123456"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: 找不到符合的會員或裝置資料
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
              example:
                success: false
                error:
                  code: "DEVICE_NOT_FOUND"
                  message: "找不到符合的會員或裝置資料"
                  details:
                    shopId: 12345
                    phone: "0912345678"
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-devices-123456"
        '500':
          $ref: '#/components/responses/InternalError'

  /notification-status/history/{notificationId}:
    get:
      tags:
        - Notification Status
      summary: 查詢通知活動歷程
      description: |
        透過通知ID查詢活動執行歷程，獲取ncId和bookDateTime

        **外部API**: Whale Notification API
        **路徑**: `/api/v1/notifications/{notificationId}`
      operationId: getNotificationHistory
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          description: 通知ID
          example: 12345
      responses:
        '200':
          description: 成功取得活動歷程
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationHistoryResponse'
              example:
                success: true
                data:
                  id: 12345
                  channel: "Push"
                  bookDatetime: "2024-01-15T10:30:00Z"
                  sentDatetime: "2024-01-15T10:35:00Z"
                  ncId: "a4070188-050d-47f7-ab24-2523145408cf"
                  ncExtId: 67890
                  status: "Success"
                  isSettled: true
                  originalAudienceCount: 1000
                  filteredAudienceCount: 950
                  sentAudienceCount: 900
                  receivedAudienceCount: 850
                  sentFailedCount: 50
                  report:
                    Total: 1000
                    Sent: 950
                    Success: 900
                    Fail: 50
                    NoUser: 50
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-history-123457"
        '404':
          description: 通知不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
              example:
                success: false
                error:
                  code: "NOTIFICATION_NOT_FOUND"
                  message: "找不到指定的通知"
                  details:
                    notificationId: 12345
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-history-123457"
        '500':
          $ref: '#/components/responses/InternalError'

  /notification-status/detail/{shopId}/{ncId}:
    get:
      tags:
        - Notification Status
      summary: 查詢通知詳細資訊
      description: |
        透過商店ID和ncId查詢通知的詳細資訊，獲取nsId

        **外部API**: NC Detail API
        **路徑**: `/api/v1/notifications/detail/{shopId}/{ncId}`
      operationId: getNotificationDetail
      parameters:
        - name: shopId
          in: path
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          description: 商店ID
          example: 12345
        - name: ncId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Notification Center ID (UUID格式)
          example: "a4070188-050d-47f7-ab24-2523145408cf"
      responses:
        '200':
          description: 成功取得通知詳細資訊 (可能為null)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationDetailResponse'
              examples:
                success:
                  summary: 成功取得資料
                  value:
                    success: true
                    data:
                      NCId: "a4070188-050d-47f7-ab24-2523145408cf"
                      NSId: "d68e720f-62ed-4955-802b-8e3f04c56a19"
                      Status: "Completed"
                      ChannelType: "Push"
                      CreateDateTime: "2025-09-15T01:58:31.117"
                      Report:
                        NoTokenData: 0
                        Received: 0
                        Total: 1
                        NoUserData: 0
                        InBlackList: 0
                        DontWantToReceiveThisMessageType: 0
                        Sent: 1
                        Fail: 0
                        DidNotSend: 0
                        Cancel: 0
                      ShortMessageReportLink: ""
                    timestamp: "2024-01-15T10:35:00Z"
                    requestId: "req-detail-123458"
                not_found:
                  summary: 資料不存在
                  value:
                    success: true
                    data: null
                    timestamp: "2024-01-15T10:35:00Z"
                    requestId: "req-detail-123458"
        '400':
          description: 參數驗證失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
              examples:
                shopId_invalid:
                  summary: ShopId驗證錯誤
                  value:
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "ShopId Out of Range"
                      details: "ShopId must be greater than 0"
                    timestamp: "2024-01-15T10:35:00Z"
                    requestId: "req-detail-123458"
                ncId_invalid:
                  summary: NCId格式錯誤
                  value:
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "NCId Should be Guid"
                      details: "NCId must be a valid GUID format"
                    timestamp: "2024-01-15T10:35:00Z"
                    requestId: "req-detail-123458"
        '500':
          $ref: '#/components/responses/InternalError'

  /notification-status/reports:
    post:
      tags:
        - Notification Status
      summary: 查詢NS狀態報告
      description: |
        透過nsId和日期查詢詳細的推播狀態報告

        **外部API**: NS Report API
        **路徑**: `/v3/GetNotificationStatusReport`

        **注意事項**:
        - 需在 180 天內查詢
        - API 會回傳 presigned URL，檔案為 TSV 格式
        - 如果等待超過 10 分鐘仍無法下載，請聯絡 Notification Service Team
      operationId: getStatusReport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusReportRequest'
            example:
              nsId: "d68e720f-62ed-4955-802b-8e3f04c56a19"
              notificationDate: "2024/01/15"
              notificationType: "push"
      responses:
        '200':
          description: 成功取得報告下載連結
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusReportResponse'
              example:
                success: true
                data:
                  downloadUrl: "https://s3.amazonaws.com/bucket/reports/report-123.tsv?signature=..."
                  expiredTime: 3600
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-report-123459"
        '400':
          description: 請求參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
              examples:
                validation_error:
                  summary: 參數驗證錯誤
                  value:
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "輸入參數驗證失敗"
                      details:
                        - field: "notificationDate"
                          message: "Date format should be YYYY/MM/DD"
                        - field: "notificationType"
                          message: "Must be one of: sms, push, line, email"
                    timestamp: "2024-01-15T10:35:00Z"
                    requestId: "req-report-123459"
                date_range_error:
                  summary: 查詢日期超過限制
                  value:
                    success: false
                    error:
                      code: "DATE_OUT_OF_RANGE"
                      message: "查詢日期必須在180天內"
                      details:
                        requestDate: "2023/01/15"
                        maxAllowedDate: "2023/07/15"
                    timestamp: "2024-01-15T10:35:00Z"
                    requestId: "req-report-123459"
        '500':
          $ref: '#/components/responses/InternalError'

  /notification-status/complete/{notificationId}:
    get:
      tags:
        - Notification Status
      summary: 完整查詢通知狀態
      description: |
        一次性查詢通知的完整狀態資訊，包含歷程、詳細資訊等

        **內部流程**:
        1. 查詢 Whale API 取得通知歷程和 ncId
        2. 使用 ncId 查詢 NC Detail API 取得詳細資訊和 nsId
        3. 合併回傳完整資訊
      operationId: getCompleteStatus
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          description: 通知ID
          example: 12345
        - name: shopId
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
          description: 商店ID
          example: 12345
      responses:
        '200':
          description: 成功取得完整狀態資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompleteStatusResponse'
              example:
                success: true
                data:
                  notificationHistory:
                    id: 12345
                    channel: "Push"
                    bookDatetime: "2024-01-15T10:30:00Z"
                    sentDatetime: "2024-01-15T10:35:00Z"
                    ncId: "a4070188-050d-47f7-ab24-2523145408cf"
                    status: "Success"
                    report:
                      Total: 1000
                      Sent: 950
                      Success: 900
                      Fail: 50
                      NoUser: 50
                  notificationDetail:
                    NCId: "a4070188-050d-47f7-ab24-2523145408cf"
                    NSId: "d68e720f-62ed-4955-802b-8e3f04c56a19"
                    Status: "Completed"
                    ChannelType: "Push"
                    CreateDateTime: "2025-09-15T01:58:31.117"
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-complete-123460"
        '404':
          description: 通知不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
              example:
                success: false
                error:
                  code: "NOTIFICATION_NOT_FOUND"
                  message: "找不到指定的通知"
                  details:
                    notificationId: 12345
                    shopId: 12345
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-complete-123460"
        '500':
          $ref: '#/components/responses/InternalError'

components:
  schemas:
    # 基礎回應格式
    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 操作是否成功
          example: true
        data:
          description: 回應資料 (依不同API而異)
        timestamp:
          type: string
          format: date-time
          description: 回應時間戳
          example: "2024-01-15T10:35:00Z"
        requestId:
          type: string
          description: 請求追蹤ID，格式：req-{api}-{timestamp}
          example: "req-devices-123456"
      required:
        - success
        - data
        - timestamp
        - requestId

    ApiErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [false]
          description: 固定為 false
        error:
          type: object
          properties:
            code:
              type: string
              description: 錯誤代碼
              enum:
                - "VALIDATION_ERROR"
                - "DEVICE_NOT_FOUND"
                - "NOTIFICATION_NOT_FOUND"
                - "DATE_OUT_OF_RANGE"
                - "EXTERNAL_API_ERROR"
                - "TIMEOUT_ERROR"
                - "RATE_LIMIT_ERROR"
                - "INTERNAL_SERVER_ERROR"
            message:
              type: string
              description: 錯誤訊息 (用戶友好)
            details:
              description: 錯誤詳細資訊 (可為物件或陣列)
          required:
            - code
            - message
        timestamp:
          type: string
          format: date-time
          description: 錯誤發生時間戳
        requestId:
          type: string
          description: 請求追蹤ID
      required:
        - success
        - error
        - timestamp
        - requestId

    # 各API專用回應格式
    DevicesResponse:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Device'

    NotificationHistoryResponse:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/NotificationHistory'

    NotificationDetailResponse:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
        - type: object
          properties:
            data:
              oneOf:
                - $ref: '#/components/schemas/NotificationDetail'
                - type: 'null'

    StatusReportResponse:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/StatusReportData'

    CompleteStatusResponse:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/CompleteStatusData'

    # 資料模型
    Device:
      type: object
      properties:
        guid:
          type: string
          format: uuid
          description: 裝置唯一識別碼
        udid:
          type: string
          description: 裝置 UDID
        token:
          type: string
          description: 推播 Token
        shopId:
          type: integer
          description: 商店 ID
        platformDef:
          type: string
          enum: ["iOS", "Android"]
          description: 平台定義
        memberId:
          type: integer
          description: 會員 ID
        advertiseId:
          type: string
          description: 廣告追蹤 ID
        appVersion:
          type: string
          description: App 版本
        createdDateTime:
          type: string
          format: date-time
          description: 建立時間
        updatedDateTime:
          type: string
          format: date-time
          description: 更新時間
      required:
        - guid
        - token
        - shopId
        - platformDef
        - memberId
        - createdDateTime
        - updatedDateTime

    NotificationHistory:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: 通知ID
        channel:
          type: string
          description: 通知頻道
          example: "Push"
        bookDatetime:
          type: string
          format: date-time
          description: 預定發送時間
        sentDatetime:
          type: string
          format: date-time
          nullable: true
          description: 實際發送時間
        ncId:
          type: string
          format: uuid
          description: Notification Center ID
        ncExtId:
          type: integer
          description: NC Extension ID
        status:
          type: string
          enum: ["Scheduled", "Booked", "Sent", "Error", "Success", "Fail", "PartialFail", "NoUser"]
          description: 通知狀態
        isSettled:
          type: boolean
          description: 是否已結算
        originalAudienceCount:
          type: integer
          description: 原始受眾數量
        filteredAudienceCount:
          type: integer
          description: 篩選後受眾數量
        sentAudienceCount:
          type: integer
          description: 實際發送數量
        receivedAudienceCount:
          type: integer
          description: 實際接收數量
        sentFailedCount:
          type: integer
          description: 發送失敗數量
        report:
          $ref: '#/components/schemas/WhaleReport'
      required:
        - id
        - channel
        - bookDatetime
        - ncId
        - status
        - isSettled

    NotificationDetail:
      type: object
      properties:
        NCId:
          type: string
          format: uuid
          description: Notification Center ID
        NSId:
          type: string
          format: uuid
          description: Notification Service ID
        Status:
          type: string
          description: 任務狀態
          example: "Completed"
        ChannelType:
          type: string
          enum: ["Push", "Email", "SMS"]
          description: 通知類型
        CreateDateTime:
          type: string
          format: date-time
          description: 建立時間
        Report:
          $ref: '#/components/schemas/NCReport'
        ShortMessageReportLink:
          type: string
          nullable: true
          description: 簡訊明細下載連結
      required:
        - NCId
        - NSId
        - Status
        - ChannelType
        - CreateDateTime
        - Report

    WhaleReport:
      type: object
      properties:
        Total:
          type: integer
          description: 總數
        Sent:
          type: integer
          description: 已發送
        Success:
          type: integer
          description: 成功數
        Fail:
          type: integer
          description: 失敗數
        NoUser:
          type: integer
          description: 無用戶數
      required:
        - Total
        - Sent
        - Success
        - Fail
        - NoUser

    NCReport:
      type: object
      properties:
        Total:
          type: integer
          description: 總共筆數
        NoUserData:
          type: integer
          description: 找不到使用者資料
        InBlackList:
          type: integer
          description: 被黑名單篩掉
        DontWantToReceiveThisMessageType:
          type: integer
          description: 不想收到這種訊息
        Sent:
          type: integer
          description: (NS)已遞送
        Fail:
          type: integer
          description: (NS)遞送失敗
        DidNotSend:
          type: integer
          description: (NS)沒有遞送出去
        Cancel:
          type: integer
          description: (NC)取消
        # Push 專用欄位
        NoTokenData:
          type: integer
          description: 沒有Token資料 (Push專用)
        Received:
          type: integer
          description: NS收到 (Push/SMS專用)
        # Email 專用欄位
        EmailIsEmpty:
          type: integer
          description: Email是空值 (Email專用)
        # SMS 專用欄位
        CellPhoneIsEmpty:
          type: integer
          description: 手機是空值 (SMS專用)
        Success:
          type: integer
          description: 客戶確實收到 (SMS專用)
        Declined:
          type: integer
          description: (供應商)取消遞送 (SMS專用)
        CellPhoneIsNotTW:
          type: integer
          description: 非TW電話 (SMS專用)
        CellPhoneIsNotMY:
          type: integer
          description: 非MY電話 (SMS專用)
      required:
        - Total
        - NoUserData
        - InBlackList
        - DontWantToReceiveThisMessageType
        - Sent
        - Fail
        - DidNotSend
        - Cancel

    StatusReportRequest:
      type: object
      properties:
        nsId:
          type: string
          format: uuid
          description: Notification Service ID
          example: "d68e720f-62ed-4955-802b-8e3f04c56a19"
        notificationDate:
          type: string
          pattern: '^\d{4}/\d{2}/\d{2}$'
          description: 通知日期 (YYYY/MM/DD格式)
          example: "2024/01/15"
        notificationType:
          type: string
          enum: [sms, push, line, email]
          description: 通知類型
          example: "push"
      required:
        - nsId
        - notificationDate
        - notificationType

    StatusReportData:
      type: object
      properties:
        downloadUrl:
          type: string
          format: uri
          description: S3 presigned URL，用於下載 TSV 報告檔
        expiredTime:
          type: integer
          description: presigned URL 的有效秒數
          example: 3600
      required:
        - downloadUrl
        - expiredTime

    CompleteStatusData:
      type: object
      properties:
        notificationHistory:
          $ref: '#/components/schemas/NotificationHistory'
        notificationDetail:
          oneOf:
            - $ref: '#/components/schemas/NotificationDetail'
            - type: 'null'
      required:
        - notificationHistory
        - notificationDetail

  responses:
    BadRequest:
      description: 請求參數錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiErrorResponse'
          example:
            success: false
            error:
              code: "VALIDATION_ERROR"
              message: "輸入參數驗證失敗"
              details: "shopId must be greater than 0"
            timestamp: "2024-01-15T10:35:00Z"
            requestId: "req-example-123461"

    NotFound:
      description: 資源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiErrorResponse'
          example:
            success: false
            error:
              code: "NOT_FOUND"
              message: "找不到指定的資源"
            timestamp: "2024-01-15T10:35:00Z"
            requestId: "req-example-123462"

    InternalError:
      description: 內部服務錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiErrorResponse'
          examples:
            external_api_error:
              summary: 外部API錯誤
              value:
                success: false
                error:
                  code: "EXTERNAL_API_ERROR"
                  message: "外部服務調用失敗"
                  details:
                    service: "Marketing Cloud API"
                    statusCode: 500
                    error: "Internal Server Error"
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-example-123463"
            timeout_error:
              summary: 請求超時
              value:
                success: false
                error:
                  code: "TIMEOUT_ERROR"
                  message: "請求處理超時"
                  details:
                    service: "Whale API"
                    timeoutMs: 10000
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-example-123463"
            rate_limit_error:
              summary: 請求頻率限制
              value:
                success: false
                error:
                  code: "RATE_LIMIT_ERROR"
                  message: "請求頻率超過限制"
                  details:
                    retryAfter: 60
                    limit: 100
                    window: "1h"
                timestamp: "2024-01-15T10:35:00Z"
                requestId: "req-example-123463"

tags:
  - name: Notification Status
    description: 推播狀態查詢相關操作
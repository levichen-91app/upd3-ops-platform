# 通知歷程追查流程

## 資料來源與流程

1. **取得 Token 資訊** v

   - 使用 `shopId / phone` 呼叫 **Marketing Cloud Device API**
   - 取得：
     - Token 清單
     - 建立時間 (`createdDateTime`)
     - 更新時間 (`updatedDateTime`)

2. **查詢活動歷程** v

   - 使用 `notificationId` 至 **Whale** 抓取：
     - `ncId`
     - `bookDateTime`

3. **取得通知細節** v

   - 使用 `ncId` 呼叫 **NC Detail API**
   - 撈取 `nsId`

4. **查詢 NS Log 檔案** v

   - 使用 `nsId`、`bookDateTime` 呼叫 **NS Report API**
   - 撈取對應 Log 檔案

5. **下載名單檔案 (Optional)**

   - 使用 `ncId` 呼叫 **NC GetPresignUrl API**
   - 下載名單檔案

6. **查詢 ShopMemberId (Optional)**
   - 使用 `shopId, phone` 呼叫 **Member Service**
   - 取得 `ShopMemberId`

---

## 🔍 判斷邏輯

a. **Token 是否存在**

- 撈取出來的 Token 清單中是否包含客戶提供的 Token？
  - ❌ 否 → Token 已更新，無法查找當時狀況。
  - ✅ 是 → 繼續判斷。

b. **Token 是否過期**

- 判斷 Token 更新時間是否 **大於 `bookDateTime`**？
  - ✅ 大於 → Token 已更新，無法查找當時狀況。
  - ❌ 否 → 繼續判斷。

c. **NS Report 中是否存在該 Token**

- 在 NS Report 檔案中查詢該 Token：
  - ✅ 存在 → 確認狀態（成功 / 失敗）。
  - ❌ 不存在 → 提交 RD 確認。

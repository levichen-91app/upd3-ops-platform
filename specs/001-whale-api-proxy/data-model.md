# Data Model: Whale API Proxy

**Date**: 2025-09-25
**Feature**: 001-whale-api-proxy

## Entity Definitions

### UpdateSupplierRequest
**Purpose**: Request payload for updating supplier IDs
**Source**: Frontend client request

**Fields**:
- `shopId: number` - Shop ID to filter stories (required, integer)
- `market: string` - System market identifier (required, string, e.g., 'TW')
- `oldSupplierId: number` - Current supplier ID to be replaced (required, integer)
- `newSupplierId: number` - New supplier ID to replace with (required, integer)

**Validation Rules**:
- All fields are required (not null/undefined)
- `shopId` must be positive integer
- `market` must be non-empty string
- `oldSupplierId` and `newSupplierId` must be positive integers
- `oldSupplierId` and `newSupplierId` should be different (business logic validation)
- No additional properties allowed (`additionalProperties: false`)

**Usage**: Validated at controller level before forwarding to Whale API

### UpdateSupplierResponse
**Purpose**: Response payload from Whale API
**Source**: Whale API response (forwarded to client)

**Success Response Fields**:
- `success: boolean` - Operation success indicator (always true for 200 responses)
- `data: object` - Response data container
  - `updatedCount: number` - Number of stories updated
  - `shopId: number` - Shop ID that was updated
  - `market: string` - Market that was updated
  - `supplierId: number` - New supplier ID that was set

**Error Response Fields**:
- `error: string` - Error message description

**Usage**: Passed through from Whale API without modification

### ProxyLogEntry
**Purpose**: Structured log entry for request/response tracking
**Source**: Generated by logging interceptor

**Fields**:
- `timestamp: string` - ISO 8601 timestamp
- `requestId: string` - Unique request identifier (UUID)
- `method: string` - HTTP method ('POST')
- `path: string` - Request path ('/proxy/whale/update-supplier-id')
- `headers: object` - Request headers (including ny-operator)
- `body: UpdateSupplierRequest | null` - Request payload (null for invalid requests)
- `responseStatus: number` - HTTP response status code
- `responseBody: any` - Response payload
- `error?: string` - Error message if applicable
- `duration?: number` - Request processing time in milliseconds

**Usage**: Generated for all requests, both successful and failed

## Relationships

### Request Flow
1. **Client** → `UpdateSupplierRequest` → **Proxy API**
2. **Proxy API** → `UpdateSupplierRequest` → **Whale API**
3. **Whale API** → `UpdateSupplierResponse` → **Proxy API**
4. **Proxy API** → `UpdateSupplierResponse` → **Client**

### Logging Flow
1. **Request received** → Generate `requestId` → Log entry created
2. **Request validated** → Update log entry with validation result
3. **External API called** → Log outgoing request
4. **Response received** → Log incoming response
5. **Response sent** → Final log entry with duration

## Validation Schema

### Input Validation (class-validator)
```typescript
class UpdateSupplierRequestDto {
  @IsInt()
  @IsPositive()
  @ApiProperty({ example: 12345 })
  shopId: number;

  @IsString()
  @IsNotEmpty()
  @ApiProperty({ example: 'TW' })
  market: string;

  @IsInt()
  @IsPositive()
  @ApiProperty({ example: 100 })
  oldSupplierId: number;

  @IsInt()
  @IsPositive()
  @ApiProperty({ example: 200 })
  newSupplierId: number;
}
```

### Business Logic Validation
- Verify `ny-operator` header presence
- Ensure `oldSupplierId !== newSupplierId`
- Validate upstream API response format

## State Transitions

### Request Processing States
1. **Received** - Initial request received
2. **Validated** - Input validation passed
3. **Forwarded** - Request sent to Whale API
4. **Processed** - Response received from Whale API
5. **Completed** - Response sent to client

### Error States
- **ValidationFailed** - Input validation failed (400)
- **HeaderMissing** - ny-operator header missing (400)
- **UpstreamError** - Whale API error (502)
- **InvalidResponse** - Unexpected response format (502)
- **InternalError** - Server error (500)

## Storage Requirements

**None** - This is a stateless proxy service with no data persistence requirements.

All data flows through the service without being stored:
- Request data is validated and forwarded
- Response data is received and forwarded
- Log data is written to logging system (not stored in application)

## Performance Considerations

### Memory Usage
- Minimal - only request/response objects in memory temporarily
- No caching or state management required
- Garbage collection handles object cleanup

### Processing Overhead
- Single HTTP request/response cycle per operation
- Minimal transformation (validation only)
- Logging overhead is acceptable for audit requirements

### Scalability
- Stateless design supports horizontal scaling
- No database bottlenecks
- Network latency limited by Whale API response time
# ç³»çµ±ç¨½æ ¸æ—¥èªŒåŠŸèƒ½

**åŠŸèƒ½ ID**: 011-011-audit-log
**ç‹€æ…‹**: âœ… å¯¦ä½œå®Œæˆï¼Œå¾…æ•´åˆ
**åˆ†æ”¯**: `011-011-audit-log`

---

## ğŸ“– æ¦‚è¿°

ç³»çµ±ç¨½æ ¸æ—¥èªŒåŠŸèƒ½æä¾›è‡ªå‹•åŒ–çš„ API æ“ä½œè¨˜éŒ„å’ŒæŸ¥è©¢èƒ½åŠ›ã€‚é€éè£é£¾å™¨æ¨™è¨˜éœ€è¦ç¨½æ ¸çš„ç«¯é»ï¼Œç³»çµ±æœƒè‡ªå‹•æ””æˆªä¸¦è¨˜éŒ„æ‰€æœ‰å¯«å…¥æ“ä½œï¼ˆPOST, PUT, PATCH, DELETEï¼‰ï¼ŒåŒ…å«å®Œæ•´çš„æ“ä½œä¸Šä¸‹æ–‡ã€æ•æ„Ÿè³‡æ–™é®ç½©ã€è‡ªå‹•æª”æ¡ˆæ¸…ç†ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ¯ **è£é£¾å™¨é©…å‹•**: ä½¿ç”¨ `@AuditLog()` æ¨™è¨˜ç«¯é»ï¼Œé¿å…ç¡¬ç·¨ç¢¼
- ğŸ”’ **æ•æ„Ÿè³‡æ–™ä¿è­·**: è‡ªå‹•éè¿´é®ç½© password, token, secret, key ç­‰æ¬„ä½
- ğŸ“ **æª”æ¡ˆç³»çµ±å„²å­˜**: JSON Lines æ ¼å¼ï¼Œæ”¯æ´æ—¥èªŒåˆ†æå·¥å…·
- ğŸ” **å¼·å¤§æŸ¥è©¢åŠŸèƒ½**: å¤šç¶­åº¦éæ¿¾ã€åˆ†é ã€7 å¤©æŸ¥è©¢ç¯„åœ
- ğŸ§¹ **è‡ªå‹•æ¸…ç†**: 30 å¤©ä¿ç•™æœŸé™ï¼Œæ¯æ—¥è‡ªå‹•æ¸…ç†
- ğŸ“Š **æ¨™æº–åŒ–éŒ¯èª¤**: Google RPC éŒ¯èª¤ä»£ç¢¼æ¨™æº–
- ğŸ”— **Request ID è¿½è¹¤**: å®Œæ•´çš„è«‹æ±‚è¿½è¹¤éˆ

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. åŸ·è¡Œè‡ªå‹•åŒ–å®‰è£è…³æœ¬

```bash
# åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ
./specs/011-011-audit-log/setup-and-verify.sh
```

æ­¤è…³æœ¬æœƒè‡ªå‹•å®Œæˆï¼š
- âœ… å®‰è£ node-cron ä¾è³´
- âœ… å»ºç«‹æ—¥èªŒç›®éŒ„
- âœ… ç·¨è­¯å°ˆæ¡ˆ
- âœ… åŸ·è¡Œæ¸¬è©¦
- âœ… é©—è­‰æª”æ¡ˆçµæ§‹

### 2. æ•´åˆåˆ°ä¸»æ‡‰ç”¨

åœ¨æ‚¨çš„ä¸»æ‡‰ç”¨æ¨¡çµ„ (é€šå¸¸æ˜¯ `api/app.module.ts`) ä¸­åŠ å…¥ï¼š

```typescript
import { AuditLogModule } from './modules/audit-log/audit-log.module';

@Module({
  imports: [
    // ... å…¶ä»–æ¨¡çµ„
    AuditLogModule,  // â† åŠ å…¥é€™è¡Œ
  ],
})
export class AppModule {}
```

### 3. å•Ÿå‹•æ‡‰ç”¨

```bash
npm run start:dev
```

### 4. æ¸¬è©¦åŠŸèƒ½

```bash
# åŸ·è¡Œä¸€å€‹éœ€è¦ç¨½æ ¸çš„æ“ä½œ
curl -X PATCH "http://localhost:3000/api/v1/shops/12345/suppliers" \
  -H "Content-Type: application/json" \
  -H "ny-operator: test@91app.com" \
  -d '{"market": "TW", "oldSupplierId": 100, "newSupplierId": 200}'

# æŸ¥è©¢ç¨½æ ¸æ—¥èªŒ
curl "http://localhost:3000/api/v1/audit-logs?limit=10" \
  -H "ny-operator: test@91app.com"

# æª¢æŸ¥æ—¥èªŒæª”æ¡ˆ
cat logs/audit/audit-$(date +%Y%m%d).jsonl | jq '.'
```

---

## ğŸ“š æ–‡æª”ç´¢å¼•

### è¦æ ¼æ–‡ä»¶
- **[åŠŸèƒ½è¦æ ¼](./spec.md)** - å®Œæ•´çš„åŠŸèƒ½éœ€æ±‚å’Œé©—æ”¶æ¨™æº–
- **[å¯¦ä½œè¨ˆåŠƒ](./plan.md)** - æŠ€è¡“é¸å‹å’Œå¯¦ä½œç­–ç•¥
- **[è³‡æ–™æ¨¡å‹](./data-model.md)** - å¯¦é«”å®šç¾©å’Œæª”æ¡ˆæ ¼å¼
- **[æŠ€è¡“ç ”ç©¶](./research.md)** - æŠ€è¡“æ±ºç­–å’Œé¢¨éšªè©•ä¼°

### API æ–‡æª”
- **[API åˆç´„](./contracts/audit-log-api.yaml)** - OpenAPI è¦ç¯„
- **[å¿«é€Ÿé–‹å§‹](./quickstart.md)** - åŠŸèƒ½é©—è­‰æŒ‡å— (15-20 åˆ†é˜)

### å¯¦ä½œæ–‡æª”
- **[ä»»å‹™æ¸…å–®](./tasks.md)** - è©³ç´°çš„å¯¦ä½œä»»å‹™åˆ†è§£
- **[å¯¦ä½œå®Œæˆå ±å‘Š](./IMPLEMENTATION_COMPLETE.md)** - å®Œæ•´çš„å¯¦ä½œæ‘˜è¦

---

## ğŸ¯ ä½¿ç”¨ç¯„ä¾‹

### æ¨™è¨˜ API ç«¯é»éœ€è¦ç¨½æ ¸

```typescript
import { AuditLog } from '../../common/decorators/audit-log.decorator';

@Controller('api/v1/shops/:shopId/suppliers')
export class SuppliersController {
  @Patch()
  @AuditLog({ page: 'supplier-management', action: 'update-supplier' })
  async updateSupplierId(
    @Param('shopId') shopId: number,
    @Body() dto: UpdateSupplierDto,
  ) {
    // å¯¦ä½œé‚è¼¯...
  }
}
```

### æŸ¥è©¢ç¨½æ ¸æ—¥èªŒ

```typescript
// æŒ‰æ“ä½œè€…æŸ¥è©¢
GET /api/v1/audit-logs?operatorFilter=admin@91app.com

// æŒ‰æ™‚é–“ç¯„åœæŸ¥è©¢
GET /api/v1/audit-logs?startDate=2025-10-01T00:00:00Z&endDate=2025-10-06T23:59:59Z

// æŒ‰æ¥­å‹™é é¢å’Œå‹•ä½œæŸ¥è©¢
GET /api/v1/audit-logs?pageFilter=supplier-management&action=update-supplier

// åˆ†é æŸ¥è©¢
GET /api/v1/audit-logs?limit=50&offset=100
```

---

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          HTTP Request (POST/PUT/...)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AuditLogInterceptor (æª¢æŸ¥ @AuditLog)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SensitiveDataMasker (é®ç½©)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FileSystemAuditLogService (å¯«å…¥æª”æ¡ˆ)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    logs/audit/audit-YYYYMMDD.jsonl          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Cron Job (æ¯æ—¥2:00)  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   æ¸…ç† 30 å¤©å‰æª”æ¡ˆ    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æª”æ¡ˆçµæ§‹

```
api/modules/audit-log/
â”œâ”€â”€ audit-log.module.ts              # æ¨¡çµ„å®šç¾©
â”œâ”€â”€ audit-log.controller.ts          # æŸ¥è©¢ API
â”œâ”€â”€ audit-log.service.ts             # ä¸»æœå‹™
â”œâ”€â”€ interfaces/
â”‚   â””â”€â”€ audit-log.interface.ts       # ä»‹é¢å®šç¾©
â”œâ”€â”€ services/
â”‚   â””â”€â”€ file-system-audit-log.service.ts  # æª”æ¡ˆç³»çµ±å¯¦ä½œ
â”œâ”€â”€ interceptors/
â”‚   â””â”€â”€ audit-log.interceptor.ts     # æ””æˆªå™¨
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ audit-log-query.dto.ts       # æŸ¥è©¢ DTO
â”‚   â””â”€â”€ audit-log-response.dto.ts    # å›æ‡‰ DTO
â””â”€â”€ integration/
    â”œâ”€â”€ audit-cleanup.integration.spec.ts
    â””â”€â”€ audit-masking.integration.spec.ts

api/common/
â”œâ”€â”€ constants/
â”‚   â”œâ”€â”€ audit-log.constants.ts       # ç¨½æ ¸å¸¸æ•¸
â”‚   â””â”€â”€ file-paths.constants.ts      # è·¯å¾‘å¸¸æ•¸
â”œâ”€â”€ decorators/
â”‚   â””â”€â”€ audit-log.decorator.ts       # @AuditLog è£é£¾å™¨
â”œâ”€â”€ exceptions/
â”‚   â””â”€â”€ audit-storage.exception.ts   # å„²å­˜ç•°å¸¸
â””â”€â”€ utils/
    â”œâ”€â”€ sensitive-data-masker.ts     # æ•æ„Ÿè³‡æ–™é®ç½©
    â””â”€â”€ audit-log-file-manager.ts    # æª”æ¡ˆç®¡ç†
```

---

## ğŸ”§ è¨­å®šé¸é …

### ç’°å¢ƒè®Šæ•¸ (å¯é¸)

```bash
# ä¿ç•™å¤©æ•¸ (é è¨­: 30)
AUDIT_LOG_RETENTION_DAYS=30

# æœ€å¤§æŸ¥è©¢å¤©æ•¸ (é è¨­: 7)
AUDIT_LOG_MAX_QUERY_DAYS=7

# é è¨­æ¯é ç­†æ•¸ (é è¨­: 50)
AUDIT_LOG_DEFAULT_LIMIT=50

# æœ€å¤§æ¯é ç­†æ•¸ (é è¨­: 100)
AUDIT_LOG_MAX_LIMIT=100
```

### å¸¸æ•¸è‡ªè¨‚

å¦‚éœ€è‡ªè¨‚æ•æ„Ÿæ¬„ä½æ¨¡å¼ï¼Œä¿®æ”¹ `api/common/constants/audit-log.constants.ts`:

```typescript
export const SENSITIVE_PATTERNS = [
  /password/i,
  /token/i,
  /secret/i,
  /key/i,
  /auth/i,
  // åŠ å…¥è‡ªè¨‚æ¨¡å¼...
] as const;
```

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

### é æœŸæ•ˆèƒ½
- **å¯«å…¥å»¶é²**: ~1-5ms (SSD)
- **æŸ¥è©¢æ™‚é–“**: <100ms (7 å¤©å…§è³‡æ–™)
- **å–®ç­†å¤§å°**: ~1-2KB
- **æ—¥æª”æ¡ˆå¤§å°**: ~100-200KB
- **30 å¤©ç¸½å®¹é‡**: ~3-6MB

### é©ç”¨å ´æ™¯
- å¯«å…¥æ“ä½œé »ç‡: â‰¤1 ops/sec
- æŸ¥è©¢é »ç‡: ç„¡ç‰¹å®šé™åˆ¶
- å–®æ¬¡æŸ¥è©¢çµæœ: â‰¤600 ç­†è¨˜éŒ„

---

## ğŸ§ª æ¸¬è©¦

### åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦

```bash
npm test -- audit-log
```

### æ¸¬è©¦è¦†è“‹ç‡

```bash
npm run test:cov
```

### æ¸¬è©¦é¡å‹
- âœ… **åˆç´„æ¸¬è©¦**: é©—è­‰ API å›æ‡‰æ ¼å¼ç¬¦åˆ OpenAPI è¦ç¯„
- âœ… **æ•´åˆæ¸¬è©¦**: ç«¯åˆ°ç«¯æµç¨‹æ¸¬è©¦
- âœ… **å–®å…ƒæ¸¬è©¦**: æ ¸å¿ƒå·¥å…·é¡åˆ¥æ¸¬è©¦

---

## âš ï¸ æ³¨æ„äº‹é …

### å®‰å…¨æ€§
- æ•æ„Ÿè³‡æ–™é®ç½©ä¸å¯é€†ï¼Œè«‹ç¢ºèªæ¨¡å¼è¨­å®šæ­£ç¢º
- æ—¥èªŒæª”æ¡ˆåŒ…å«æ“ä½œè³‡è¨Šï¼Œæ‡‰è¨­å®šé©ç•¶æ¬Šé™
- å»ºè­°å®šæœŸå‚™ä»½ç¨½æ ¸æ—¥èªŒ

### æ•ˆèƒ½
- åŒæ­¥å¯«å…¥é©åˆä½å®¹é‡å ´æ™¯
- é«˜å®¹é‡å ´æ™¯å»ºè­°é·ç§»è‡³è³‡æ–™åº«
- ç›£æ§ç£ç¢Ÿç©ºé–“ä½¿ç”¨

### ç¶­è­·
- å®šæœŸæª¢æŸ¥æ—¥èªŒæª”æ¡ˆå¤§å°
- é©—è­‰è‡ªå‹•æ¸…ç†æ©Ÿåˆ¶é‹ä½œæ­£å¸¸
- æ ¹æ“šå¯¦éš›ä½¿ç”¨èª¿æ•´ä¿ç•™å¤©æ•¸

---

## ğŸ”„ å¾ŒçºŒæ“´å±•

### çŸ­æœŸ
- [ ] æ–°å¢æ›´å¤š API ç«¯é»çš„ç¨½æ ¸æ¨™è¨˜
- [ ] å¯¦ä½œå‰ç«¯ç®¡ç†ä»‹é¢
- [ ] æ–°å¢ç¨½æ ¸çµ±è¨ˆåŠŸèƒ½

### ä¸­æœŸ
- [ ] é·ç§»è‡³ PostgreSQL (åˆ©ç”¨æŠ½è±¡ä»‹é¢)
- [ ] å¯¦ä½œå…¨æ–‡æœå°‹åŠŸèƒ½
- [ ] æ–°å¢ç¨½æ ¸å ±è¡¨åŠŸèƒ½

### é•·æœŸ
- [ ] æ•´åˆ ELK Stack
- [ ] å¯¦ä½œå³æ™‚å‘Šè­¦æ©Ÿåˆ¶
- [ ] æ–°å¢ç•°å¸¸æª¢æ¸¬åŠŸèƒ½

---

## ğŸ“ æ”¯æ´èˆ‡å•é¡Œå›å ±

### ç›¸é—œè³‡æº
- **å°ˆæ¡ˆæ†²ç« **: `.specify/memory/constitution.md`
- **é–‹ç™¼è¦ç¯„**: `CLAUDE.md`
- **GitHub Issues**: [å°ˆæ¡ˆå•é¡Œè¿½è¹¤](https://github.com/your-org/upd3-ops-platform/issues)

### å¸¸è¦‹å•é¡Œ

**Q: å¦‚ä½•æ–°å¢æ›´å¤šéœ€è¦ç¨½æ ¸çš„ APIï¼Ÿ**
A: åœ¨ Controller æ–¹æ³•ä¸ŠåŠ å…¥ `@AuditLog({ page, action })` è£é£¾å™¨å³å¯ã€‚

**Q: æ•æ„Ÿè³‡æ–™é®ç½©è¦å‰‡å¯ä»¥è‡ªè¨‚å—ï¼Ÿ**
A: å¯ä»¥ï¼Œä¿®æ”¹ `api/common/constants/audit-log.constants.ts` ä¸­çš„ `SENSITIVE_PATTERNS`ã€‚

**Q: å¦‚ä½•èª¿æ•´æª”æ¡ˆä¿ç•™å¤©æ•¸ï¼Ÿ**
A: ä¿®æ”¹ç’°å¢ƒè®Šæ•¸ `AUDIT_LOG_RETENTION_DAYS` æˆ–å¸¸æ•¸ `AUDIT_LOG_RETENTION.RETENTION_DAYS`ã€‚

**Q: æŸ¥è©¢æ•ˆèƒ½ä¸ç†æƒ³æ€éº¼è¾¦ï¼Ÿ**
A: è€ƒæ…®é·ç§»è‡³è³‡æ–™åº«å„²å­˜ï¼Œåˆ©ç”¨ç¾æœ‰çš„ `IAuditLogService` æŠ½è±¡ä»‹é¢å¯¦ä½œ DatabaseAuditLogServiceã€‚

---

## âœ… é©—æ”¶æ¸…å–®

å¯¦ä½œå®Œæˆå¾Œï¼Œè«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

- [ ] åŸ·è¡Œ `setup-and-verify.sh` è…³æœ¬æˆåŠŸ
- [ ] AuditLogModule å·²æ•´åˆåˆ°ä¸»æ‡‰ç”¨
- [ ] æ‡‰ç”¨å¯ä»¥æ­£å¸¸å•Ÿå‹•
- [ ] åŸ·è¡Œå¯«å…¥æ“ä½œæ™‚è‡ªå‹•ç”¢ç”Ÿç¨½æ ¸æ—¥èªŒ
- [ ] æŸ¥è©¢ API å¯æ­£å¸¸é‹ä½œ
- [ ] æ•æ„Ÿè³‡æ–™å·²æ­£ç¢ºé®ç½©
- [ ] æ—¥èªŒæª”æ¡ˆæ ¼å¼ç¬¦åˆ JSON Lines è¦ç¯„
- [ ] æ¸¬è©¦è¦†è“‹ç‡é”æ¨™ (å–®å…ƒ â‰¥95%, æ•´åˆ â‰¥80%)

---

**å¯¦ä½œå®Œæˆæ—¥æœŸ**: 2025-10-06
**ç‰ˆæœ¬**: 1.0.0
**ç‹€æ…‹**: âœ… Ready for Integration
